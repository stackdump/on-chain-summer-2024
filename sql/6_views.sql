DROP MATERIALIZED VIEW transaction_logs_view ;
CREATE MATERIALIZED VIEW transaction_logs_view AS
WITH expanded_logs AS (
    SELECT
        transaction_hash,
        block_number,
        jsonb_array_elements(logs) AS log_entry,
        ROW_NUMBER() OVER (PARTITION BY transaction_hash ORDER BY transaction_hash) AS log_index,
        transaction_details->'result'->>'from' AS from_address
    FROM transactions
    WHERE logs IS NOT NULL
)
SELECT
    transaction_hash,
    block_number,
    log_index,
    from_address,
    log_entry->>'data' AS data,
    CAST(log_entry->>'removed' AS BOOLEAN) AS removed,
    CAST('TicTacToe' AS topic_enum) AS topic_hash,
    CAST(
        CASE
            WHEN (log_entry->'topics'->>1) = '0x0000000000000000000000000000000000000000000000000000000000000000' THEN 'X'
            WHEN (log_entry->'topics'->>1) = '0x0000000000000000000000000000000000000000000000000000000000000001' THEN 'O'
            WHEN (log_entry->'topics'->>1) = '0x0000000000000000000000000000000000000000000000000000000000000002' THEN 'HALT'
        END AS role_enum
    ) AS role,
    CAST(
        CASE
            WHEN (log_entry->'topics'->>2) = '0x0000000000000000000000000000000000000000000000000000000000000000' THEN 'X00'
            WHEN (log_entry->'topics'->>2) = '0x0000000000000000000000000000000000000000000000000000000000000001' THEN 'X01'
            WHEN (log_entry->'topics'->>2) = '0x0000000000000000000000000000000000000000000000000000000000000002' THEN 'X02'
            WHEN (log_entry->'topics'->>2) = '0x0000000000000000000000000000000000000000000000000000000000000003' THEN 'X10'
            WHEN (log_entry->'topics'->>2) = '0x0000000000000000000000000000000000000000000000000000000000000004' THEN 'X11'
            WHEN (log_entry->'topics'->>2) = '0x0000000000000000000000000000000000000000000000000000000000000005' THEN 'X12'
            WHEN (log_entry->'topics'->>2) = '0x0000000000000000000000000000000000000000000000000000000000000006' THEN 'X20'
            WHEN (log_entry->'topics'->>2) = '0x0000000000000000000000000000000000000000000000000000000000000007' THEN 'X21'
            WHEN (log_entry->'topics'->>2) = '0x0000000000000000000000000000000000000000000000000000000000000008' THEN 'X22'
            WHEN (log_entry->'topics'->>2) = '0x0000000000000000000000000000000000000000000000000000000000000009' THEN 'O00'
            WHEN (log_entry->'topics'->>2) = '0x000000000000000000000000000000000000000000000000000000000000000a' THEN 'O01'
            WHEN (log_entry->'topics'->>2) = '0x000000000000000000000000000000000000000000000000000000000000000b' THEN 'O02'
            WHEN (log_entry->'topics'->>2) = '0x000000000000000000000000000000000000000000000000000000000000000c' THEN 'O10'
            WHEN (log_entry->'topics'->>2) = '0x000000000000000000000000000000000000000000000000000000000000000d' THEN 'O11'
            WHEN (log_entry->'topics'->>2) = '0x000000000000000000000000000000000000000000000000000000000000000e' THEN 'O12'
            WHEN (log_entry->'topics'->>2) = '0x000000000000000000000000000000000000000000000000000000000000000f' THEN 'O20'
            WHEN (log_entry->'topics'->>2) = '0x0000000000000000000000000000000000000000000000000000000000000010' THEN 'O21'
            WHEN (log_entry->'topics'->>2) = '0x0000000000000000000000000000000000000000000000000000000000000011' THEN 'O22'
            WHEN (log_entry->'topics'->>2) = '0x0000000000000000000000000000000000000000000000000000000000000012' THEN 'HALT'
        END AS action_enum
    ) AS action,
    CAST(
        CASE
            WHEN (log_entry->'topics'->>3) = '0x0000000000000000000000000000000000000000000000000000000000000001' THEN '1'
            ELSE '0'
        END AS scalar_enum
    ) AS scalar
FROM expanded_logs
ORDER BY block_number, log_index;
